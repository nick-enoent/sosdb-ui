{% include "base.html" %}
{% block main %}

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="language" content="en" />

  <title>OVIS Component Viewer</title>


<style>

#compTableDiv {
    width: 70%;
    float: left;
    margin-top: 1em;
}
.select-div {
    float: left;
    margin-left: .5em;
    margin-right: .5em;
}
</style>
<script type="text/javascript">

function formatDate(aDate) {
    var str = aDate.getFullYear();
    var year = aDate.getFullYear(),
    mon = aDate.getMonth() + 1,
    day = aDate.getDate(),
    hour = aDate.getHours(),
    minute = aDate.getMinutes(),
    second = aDate.getSeconds();

    str = year;
    if (mon < 10)
        str += '/0' + mon;
    else
        str += '/' + mon;

    if (day < 10)
        str += '/0' + day;
    else
        str += '/' + day;

    str += ' ';

    if (hour < 10)
        str += '0' + hour;
    else
        str += hour;

    if (minute < 10)
        str += ':0' + minute;
    else
        str += ':' + minute;

    return str;
}

/*function timestr_to_timestamp(timestr) {
    var dt = timestr.split(' ');
    var aDate = dt[0].split('/');
    var aTime = dt[1].split(':');
    var msecs = new Date(aDate[0], aDate[1]-1, aDate[2],
                         aTime[0], aTime[1], aTime[2]);
    return msecs / 1000;
}*/

function updateContainerSel() {
    $.ajax({
        url: "/sos_db/directory/",
        dataType: 'json',
        success: function (obj) {
            var i, o;
            $("#containers option").remove();
            for (i = 0; i < obj.directory.length; i++) {
                o = document.createElement("OPTION");
                o.value = obj.directory[i].name;
                o.text = obj.directory[i].name;
                o.obj = obj;
                $("#containers").append($(o).clone());
            }
            var idxOpts = $("#containers option");
            idxOpts.sort(function(a,b) {
                if (a.label < b.label)
                    return -1;
                else if (a.label == b.label)
                    return 0;
                return 1;
            });
            $("#containers").empty().append(idxOpts);
            if ($("#containers").length > 0) {
                updateSchemaSel();
                $("#containers option:first-child").attr("selected","selected");
                buildComponentTable();
            }
        }
    });
}

function updateSchemaSel() {
    var cname = $("#containers").val();
    $.ajax({
        url: "/sos_db/container/",
        data: "container="+cname,
        dataType: 'json',
        success: function(obj) {
            if (obj.error) {
                return alert(obj.error);
            }
            var i, o;
            $("#schema").empty();
            $("#schema option").remove();
            for (i=0; i < obj.container.schema.length; i++) {
                o = document.createElement("OPTION");
                o.value = obj.container.schema[i].Name;
                o.text = obj.container.schema[i].Name;
                $("#schema").append(o);
            }
            updateMetricTable();
        },
        error: function(xhr, desc, er) {
            alert(xhr.responseText);
        }
    });
}

function updateMetricTable() {
    var container = $("#containers").val();
    var schema = $("#schema").val();
    $.ajax({
        url: "/sos_db/schema/",
        data: "container="+container+"&schema="+schema,
        dataType: 'json',
        success: function (obj) {
            if ('error' in obj) {
                return alert("The container " + container + " could not be opened.")
            }
            var metricData = new Array();
            /* Add all the attributes to the metricTable */
            for (var i = 0; i < obj.schema.attrs.length; i++) {
                attr = obj.schema.attrs[i];
                var metric = [ attr.name, attr.sos_type ];
                metricData[i] = metric;
            }
            metricTable.fnClearTable(false);
            metricTable.fnAddData(metricData, true);
        },
        error: function (xhr, desc, er) {
            alert(xhr.responseText);
        }
    });
}

function updateTable(table, urlSrc, objSrc, cbFn, cbArg) {
    $.ajax({
        "url" : urlSrc,
        dataType : "json",
        success : function(obj) {
            if (obj.error) {
                alert(obj.error);
                return;
            }
            table.fnClearTable(true);
            var data = obj[objSrc];
            if (data.length > 0)
                table.fnAddData(obj[objSrc]);
            cbFn(table, cbArg);
        },
        error : function(xhr, status, err) {
            alert(err);
        }
    });
}

function tableUpdateCb(table, selRowIdx) {
    if (selRowIdx < 0)
        return;
    row = table.DataTable().row(selRowIdx).node();
    $(row).addClass('selected');
}

function updateComponentTable() {
    var container = $("#containers").val();
    updateSchemaSel();
    var url = "/sos_db/query/?type=table&container=" + encodeURIComponent(container)
        + "&schema=Component"
        + "&index=Id"
    compTable.clear();
    compTable.ajax.url(url).load();
}

var tbl_start_time;
var tbl_end_time;
function update_container(container_el) {
    var cname = $("#containers").val();
    var sname = $("#schema").val();
    $.ajax({
        url: "/sos_db/schema/",
        data: "container="+cname+"&schema="+sname,
        dataType: 'json',
        success: function (obj) {
            if ('error' in obj) {
                return alert("The container " + cname + " could not be opened.")
            }
            var metricData = new Array();
            /* Add all the attributes to the metricTable */
            for (var i = 0; i < obj.schema.attrs.length; i++) {
                attr = obj.schema.attrs[i];
                var metric = [ attr.name, attr.sos_type ];
                metricData[i] = metric;
                if (attr.name != "Id") {
                    continue;
                }
                /*
                 * SOS Timestamp is 32b (seconds) | 32b (microseconds)
                
                var aTime = parseInt(attr.min_key);
                /* Convert aTime to seconds */
                //aTime = aTime / 1024 / 1024 / 1024 / 4;
                //tbl_start_time = aTime;
                /* Convert aTime to milliseconds and construct a Date 
                aTime = aTime * 1000;
                var aDate = new Date(aTime);
                /* Initialize the start-time control 
                $('#comp_start_time').datetimepicker({
                    mask: '9999/19/39 29:59',
                    timepicker : true,
                    hmspicker : false,
                    format : "Y/m/d H:i",
                    step : 30,
                    value : aDate,
                    onClose : function(time, el, event) {
                        var cname = $("#containers").val();
                        tbl_start_time = Date.parse(el.val()) / 1000;
                        update_comps(cname);
                    },
                });
                var aDateStr = formatDate(aDate);
                $('#comp_start_time').val(aDateStr);

                aTime = parseInt(attr.max_key);
                aTime = aTime / 1024 / 1024 / 1024 / 4;
                tbl_end_time = aTime;
                aDate = new Date(aTime * 1000);
                $('#comp_end_time').datetimepicker({
                    mask: '9999/19/39 29:59',
                    timepicker : true,
                    hmspicker : false,
                    format : "Y/m/d H:i",
                    step : 30,
                    value : aDate,
                    onClose : function(time, el, event) {
                        var cname = $("#containers").val();
                        tbl_end_time = Date.parse(el.val()) / 1000;
                        update_comps(cname);
                    },
                });
                aDateStr = formatDate(aDate);
                $('#comp_end_time').val(aDateStr);
                */
            }
            metricTable.fnClearTable(false);
            metricTable.fnAddData(metricData, true);
        },
        error: function (xhr, desc, er) {
            alert(xhr.responseText);
        }
    });
}

function tableClick(table, row) {
    var metric = metricTable.$('tr.selected');
    var component = compTable.$('tr.selected');
        
    if ($(row).hasClass('selected')) {
        $(row).removeClass('selected');
    } else {
        if (table.selector == "#compTable" && metric.length > 1 && component.length >= 1){
            metricTable.$('tr.selected').removeClass('selected');
        } else if (table.selector == "#metricTable" && component.length > 1 && metric.length >= 1) {
            compTable.$('tr.selected').removeClass('selected');
        }
        $(row).addClass('selected');
    }
    /* Turn on the graph button if both a metric and a component are selected 
    if (metric.length > 0 && component.length > 0)
	$(".graph-button").button("option", { disabled : false });
    else
	$(".graph-button").button("option", { disabled : true });
    */
}

var compTable, metricTable;
function buildComponentTable() {
    var container = $("#containers").val();
    var dataSrc = "/sos_db/query/?type=table&container=" + encodeURIComponent(container)
        + "&schema=Component"
        + "&index=Id"
    /* Component Table */
    compTable = $("#compTable").DataTable({
        retrieve : true,
        sDom: '<"top"f>rt<"bottom"ip><"clear">',
        ajax : dataSrc,
        //sAjaxSource : dataSrc,
        sAjaxDataProp : "Component",
        processing : true,
        serverSide : true,
        bFilter : true,
        paging : true,
        bAutoWidth : true,
        order : [ [ 0, 'asc' ] ],
        ordering : true,
        lengthChange : false,
        sScrollY : "23em",
        aoColumns : [
            {
                sName    : 'Name',
                mDataProp : 'Name',
                bSortable : true,
            },
            {
                sName    : 'Description',
                mDataProp : 'Description',
                bSearchable : true,
                bSortable : true,
            },
            {
                sName    : 'Comp Id',
                mDataProp : 'Id',
                bSortable : true,
            }
        ],
    });
    $("#compTable tbody").delegate("tr", "click", function() {
	tableClick(compTable, this);
    });
}

$(document).ready( function() {
    /* Metric Table */
    var aaData = Array();
    metricTable = $("#metricTable").dataTable({
        "sDom": '<"top"f>rt<"bottom"l><"clear">',
        "paging" : false,
        "bAutoWidth" : true,
        "order" : [ [ 0, 'asc' ] ],
        "ordering" : true,
        "lengthChange" : false,
        "sScrollY" : "23em",
        "aaData" : aaData,
        "aoColumns" : [
            { sTitle : "Name", bSortable : true },
            { sTitle : "Type", bSortable : false }
        ],
    });
    $("#metricTable tbody").delegate("tr", "click", function() {
        tableClick(metricTable, this);
    });

    $( document ).tooltip({
        position: {
            my: "center bottom-20",
            at: "center top",
            using: function( position, feedback ) {
                $( this ).css( position );
                $( "<div>" )
                    .addClass( "arrow" )
                    .addClass( feedback.vertical )
                    .addClass( feedback.horizontal )
                    .appendTo( this );
            }
        }
    });

    $("#add-graph-btn").button({ "disabled" : false }).on("click", function(event) {
        addGraph();
    });

    updateContainerSel();
});

function addGraph() {
    var container = $("#containers").val();
    var schema = $("#schema").val();
    var compRow = compTable.$('.selected')[0];
    var compRowData  = compTable.row(compRow).data();
    var d = new Date();
    var graph_start = d.getTime();
    graph_start = parseInt(graph_start/1000);
    var comp_id = parseInt(compRowData.Id);
    var metric_name = '';
    for (i=0, len=compTable.$('.selected').length; i<len; i++) {
        if (i > 0){
            comp_id+=',';
        }
        var compRow = compTable.$('.selected')[i];
        var compRowData = compTable.row(compRow).data();
        comp_id += compRowData.Id;
    }
    for (i=0, len=metricTable.$('.selected').length; i<len; i++) {
        if (i > 0){
            metric_name+=',';
        }
        var metricRow = metricTable.$('.selected')[i];
        var metricRowData =  metricTable.DataTable().row(metricRow).data();
        metric_name += metricRowData[0];
    }

    /* Add a new graph */
    var duration = 3600;
    var url = "/plot/job/?container=" + encodeURIComponent(container)
        + "&schema=" + encodeURIComponent(schema)
        + "&comp_id=" + comp_id
        + "&metric_name=" + encodeURIComponent(metric_name)
		+ "&start=" + graph_start;
    window.open(url, schema + ":" + metric_name, "width=850px, height=320px, modal=yes");
}

</script>
</head>
<body>
<div id="main">
  <div id="north">
    <div style="margin-top: .5em">
      <div class="select-div">
        <label for="containers"
               class="block_label" title="Select the container">Container
        </label>
        <select name="containers" style="width: 14em"
                onchange="updateComponentTable()" id="containers"></select>
      </div>
      <div class="select-div">
        <label for="schema" class="block_label" title="Select Schema">Schema
        </label>
        <select name="schema" style="width: 14em"
		onchange="updateMetricTable()" id="schema"></select>
      </div>
    </div>
    <br style="clear:both"/>
    <div id="compTableDiv" style="float: left; margin-top: 1em; width: 50%;">
      <table id="compTable" class="display">
	<thead>
	  <tr>
	    <th title="Click on a row to select a component" style="text-align:center;" colspan="3">Components</th>
	  </tr>
	  <tr>
	    <th title="Click on a row to select a component">Name</th>
	    <th title="Click on a row to select a component">Description</th>
	    <th title="Click on a row to select a component">Id</th>
	  </tr>
	</thead>
      </table>
    </div>
    <div id="metricTableDiv" style="float: left; margin-top: 1em; width: 50%;">
      <table id="metricTable" class="display">
        <thead>
	  <tr>
	    <th title="Click on a row to select a metric" colspan="2" style="text-align:center;">Metrics</th>
	  </tr>
          <tr>
            <th title="Click on a row to select a metric">Name</th>
            <th title="Click on a row to select a metric">Type</th>
          </tr>
        </thead>
      </table>
    </div>
    <br style="clear: both"/>
    <div>
      <button type="button" id="add-graph-btn" class="graph-button">Add Graph</button>
    </div>
  </div>
</div>
</body>
{% endblock %}
